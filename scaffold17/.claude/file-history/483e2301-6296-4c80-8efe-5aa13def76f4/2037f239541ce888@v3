'use client';

import {
  Client,
  cacheExchange,
  fetchExchange,
  subscriptionExchange,
  errorExchange,
} from 'urql';
import { createClient as createWSClient, Client as WSClient } from 'graphql-ws';

let wsClient: WSClient | null = null;

// Only create WebSocket client on the client side
if (typeof window !== 'undefined') {
  try {
    wsClient = createWSClient({
      url:
        process.env.NEXT_PUBLIC_GRAPHQL_WS_URL || 'ws://localhost:8002/graphql',
      retryAttempts: 2,
      shouldRetry: () => false, // Don't retry if backend is unavailable
      connectionParams: () => ({
        // Add any auth tokens here if needed
      }),
      on: {
        error: () => {
          // Silently handle WebSocket connection errors
        },
      },
    });
  } catch {
    // WebSocket client creation failed, continue without it
    wsClient = null;
  }
}

export const graphqlClient = new Client({
  url: process.env.NEXT_PUBLIC_GRAPHQL_URL || 'http://localhost:8002/graphql',
  exchanges: [
    errorExchange({
      onError: (error) => {
        // Log errors in development only, don't crash the app
        if (process.env.NODE_ENV === 'development') {
          console.warn('[GraphQL] Request failed:', error.message);
        }
      },
    }),
    cacheExchange,
    fetchExchange,
    ...(wsClient
      ? [
          subscriptionExchange({
            forwardSubscription: (request) => ({
              subscribe: (sink) => ({
                unsubscribe: wsClient!.subscribe(
                  { ...request, query: request.query || '' },
                  sink
                ),
              }),
            }),
          }),
        ]
      : []),
  ],
  requestPolicy: 'cache-and-network',
});

// Create a fresh client for SSR without subscriptions
export const createSSRClient = () =>
  new Client({
    url: process.env.NEXT_PUBLIC_GRAPHQL_URL || 'http://localhost:8002/graphql',
    exchanges: [cacheExchange, fetchExchange],
    suspense: true,
  });
