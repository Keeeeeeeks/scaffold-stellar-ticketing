'use client';

import { useQuery } from 'urql';
import { motion } from 'framer-motion';
import { ACCOUNT_BY_ADDRESS, ACCOUNT_BALANCES } from '@/lib/graphql/queries';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';
import { Badge } from '@/components/ui/badge';
import { AddressDisplay } from '@/components/shared/AddressDisplay';
import { CopyButton } from '@/components/shared/CopyButton';
import { ErrorState, NotFoundState } from '@/components/shared/ErrorState';
import { AccountSkeleton } from '@/components/shared/LoadingState';
import { BalanceList } from './BalanceList';
import { TransactionHistory } from './TransactionHistory';
import { Wallet, Code, ArrowLeftRight, Coins, ExternalLink } from 'lucide-react';
import { formatXLM } from '@/lib/utils/format';
import { SPRING } from '@/lib/utils/constants';

interface AccountDetailProps {
  address: string;
  isContract?: boolean;
}

export function AccountDetail({ address, isContract = false }: AccountDetailProps) {
  const [{ data: accountData, fetching: accountFetching, error: accountError }] =
    useQuery({
      query: ACCOUNT_BY_ADDRESS,
      variables: { address },
    });

  const [{ data: balanceData, fetching: balancesFetching }] = useQuery({
    query: ACCOUNT_BALANCES,
    variables: { addresses: [address] },
  });

  if (accountFetching) return <AccountSkeleton />;
  if (accountError) return <ErrorState message={accountError.message} />;

  const balances = balanceData?.accountBalances?.[0]?.balances || [];
  const nativeBalance = balances.find((b: any) => b.tokenType === 'NATIVE');

  return (
    <motion.div
      initial={{ opacity: 0, y: 20 }}
      animate={{ opacity: 1, y: 0 }}
      transition={SPRING.gentle}
      className="space-y-6"
    >
      {/* Header */}
      <div className="flex items-start justify-between gap-4 flex-wrap">
        <div>
          <div className="flex items-center gap-3 mb-2">
            {isContract ? (
              <div className="p-2 rounded-lg bg-purple-500/10">
                <Code className="h-6 w-6 text-purple-500" />
              </div>
            ) : (
              <div className="p-2 rounded-lg bg-blue-500/10">
                <Wallet className="h-6 w-6 text-blue-500" />
              </div>
            )}
            <h1 className="text-2xl font-bold">
              {isContract ? 'Contract' : 'Account'}
            </h1>
            {isContract && (
              <Badge className="bg-purple-500/10 text-purple-500 border-purple-500/20">
                Soroban Contract
              </Badge>
            )}
          </div>
          <div className="flex items-center gap-2 text-muted-foreground">
            <span className="font-mono text-sm break-all">{address}</span>
            <CopyButton value={address} />
          </div>
        </div>

        {/* Quick Balance Display */}
        {nativeBalance && (
          <motion.div
            initial={{ opacity: 0, scale: 0.9 }}
            animate={{ opacity: 1, scale: 1 }}
            transition={{ delay: 0.1, ...SPRING.gentle }}
            className="text-right"
          >
            <div className="text-sm text-muted-foreground">Balance</div>
            <div className="text-2xl font-bold">
              {formatXLM(nativeBalance.balance)} XLM
            </div>
          </motion.div>
        )}
      </div>

      {/* Main Content */}
      <motion.div
        initial={{ opacity: 0, y: 10 }}
        animate={{ opacity: 1, y: 0 }}
        transition={{ delay: 0.1, ...SPRING.gentle }}
      >
        <Tabs defaultValue="balances">
          <TabsList>
            <TabsTrigger value="balances" className="gap-2">
              <Coins className="h-4 w-4" />
              Balances
            </TabsTrigger>
            <TabsTrigger value="transactions" className="gap-2">
              <ArrowLeftRight className="h-4 w-4" />
              Transactions
            </TabsTrigger>
            {isContract && (
              <TabsTrigger value="contract" className="gap-2">
                <Code className="h-4 w-4" />
                Read/Write
              </TabsTrigger>
            )}
          </TabsList>

          <TabsContent value="balances" className="mt-4">
            <BalanceList balances={balances} loading={balancesFetching} />
          </TabsContent>

          <TabsContent value="transactions" className="mt-4">
            <TransactionHistory
              address={address}
              initialData={accountData?.accountByAddress?.transactions}
            />
          </TabsContent>

          {isContract && (
            <TabsContent value="contract" className="mt-4">
              <Card>
                <CardContent className="py-8 text-center">
                  <Code className="h-12 w-12 text-muted-foreground mx-auto mb-4" />
                  <h3 className="font-semibold mb-2">Contract Interaction</h3>
                  <p className="text-sm text-muted-foreground max-w-md mx-auto">
                    Contract interaction UI is coming soon. Visit the dedicated
                    contract page for the full interaction experience.
                  </p>
                </CardContent>
              </Card>
            </TabsContent>
          )}
        </Tabs>
      </motion.div>
    </motion.div>
  );
}
