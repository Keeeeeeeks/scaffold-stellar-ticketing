import { useEffect, useState } from "react";
import { getTransactionUrl, truncateHash } from "../../util/explorer";

interface TransactionLinkProps {
  txHash: string;
  truncate?: boolean;
  className?: string;
}

const GRAPHQL_URL = "http://localhost:8002/graphql";

export function TransactionLink({
  txHash,
  truncate = true,
  className = "",
}: TransactionLinkProps) {
  const [explorerAvailable, setExplorerAvailable] = useState<boolean | null>(
    null
  );

  useEffect(() => {
    const checkExplorer = async () => {
      try {
        const response = await fetch(GRAPHQL_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ query: "{ __typename }" }),
        });
        setExplorerAvailable(response.ok);
      } catch {
        setExplorerAvailable(false);
      }
    };

    checkExplorer();
  }, []);

  const displayHash = truncate ? truncateHash(txHash) : txHash;
  const url = getTransactionUrl(txHash);

  if (explorerAvailable === null) {
    return (
      <span className={`font-mono text-sm ${className}`}>{displayHash}</span>
    );
  }

  if (!explorerAvailable) {
    return (
      <span
        className={`font-mono text-sm ${className}`}
        title="Block explorer not available"
      >
        {displayHash}
      </span>
    );
  }

  return (
    <a
      href={url}
      target="_blank"
      rel="noopener noreferrer"
      className={`font-mono text-sm text-blue-600 hover:text-blue-800 hover:underline inline-flex items-center gap-1 ${className}`}
      title={`View transaction ${txHash} on Soroscan`}
    >
      {displayHash}
      <svg
        xmlns="http://www.w3.org/2000/svg"
        width="12"
        height="12"
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        strokeWidth="2"
        strokeLinecap="round"
        strokeLinejoin="round"
        className="inline-block"
      >
        <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6" />
        <polyline points="15 3 21 3 21 9" />
        <line x1="10" y1="14" x2="21" y2="3" />
      </svg>
    </a>
  );
}
